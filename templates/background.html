<!-- 1)change path from tokenize to getkeyword 2)show loading image till XHR request does not complete
	3)get result containg all keyword and result of first 4 keyword
-->>
<html>
<head>
<script type="text/javascript" src="jquery-1.4.2.js"></script>

<script>
		//since following variable will be changed in callback function..so here declaration is sufficient..
		//...it is working for different tab without reloading extension
		//global variable declared
		var count=-1,total_count=0,global_response,flag=0;
		
	  	// Called when the user clicks on the browser action.
	  	//chrome.browserAction.onClicked.addListener(function(tab) {
	  	function keyword(pageurl){
	  		//pass url of page from popup
	  		//alert("from keyword :"+pageurl);
			chrome.tabs.executeScript(null,{code:"$('.layout').show();"});
			//$.getJSON('http://127.0.0.1:5000/get_keyword',{					//test
			alert("before AJAX request to tokenize");
			$.getJSON('http://127.0.0.1:5000/tokenize',{
					   		//url:tab.url
					   		url:pageurl
				  			}, function(response) {
				  					alert("callback function of tokenize");
									global_response=response;
									total_count=response.final_results.length;
									total_count-=1;
									if(total_count>=4)
									{
										show_keyword(0,3);
										count=3;
									}
									else
									{
										show_keyword(0,total_count-1);
										count = total_count-1;
									}
									//get_tweets();
									//get_remaining_keyword_result();    //test
									flag = 0;
									alert("before returning to popup.html");
									//sendResponse({"result":"pong"});		//return to callback function of popup.html
				});
				alert("after AJAX request to tokenize");	
		//});
		}
		
		/*																//test
		function get_remaining_keyword_result()
		{
			//get list of keyword
			var keyword=new array();																			//test
			for(var i=4;i<total_count;i++)								//passing keywords next to 4th keyword
			{
				keyword[i] = global_response.final_results[i].keyword;
			}
			if(total_count>4)
			{
				$.getJSON('http://127.0.0.1:5000/get_remaining_keyword_result',{                             //test
						   key:keyword		                                                             //test
					  	}, function(response) {
							for(var i=4;i<total_count;i++)					
							{
								global_response.final_result[i].search_res[i].Url=response.final_result[i].search_res[i].Url
								global_response.final_result[i].search_res[i].Url=response.final_result[i].search_res[i].Url	
							}			  			
				});
			}
		}		
		*/
		function show_keyword(start,end){	
			for(var i=start;i<=end && i<total_count;i++)
			{
				alert(i);
				chrome.tabs.executeScript(null,{code:"$('p#keyword"+(i%4+1)+"').text('"+global_response.final_results[i].keyword+"');"});			//W
				print_res_of_kwd(i);
			}	
			//if less than four keyword are displayed then fill other with blank	
			if(end-start<3)
			{
				for(var i=end-start+1;i<=3;i++)
				{
					chrome.tabs.executeScript(null,{code:"$('p#keyword"+(i+1)+"').empty();"});
					chrome.tabs.executeScript(null,{code:"$('div.popup_keyword"+(i+1)+"').empty();"});		
				}
			}
		}	 
		
	 	function print_res_of_kwd(index)
	 	{
			var markup = "<ul>",clss;
			for(i = 0; i<3 ; i++)
			{	
				//str = str.replace(/'/g,"");       //to replace quotes in string with blank string..working properly
				markup += "<li><a href="+ global_response.final_results[index].search_res[i].Url+">"+global_response.final_results[index].search_res[i].Title.replace(/'/g,"")+"</a></li>";
			}
			markup += "</ul>"
			//alert(markup);            
			clss = "div.popup_keyword"+(index%4+1)
			//chrome.tabs.executeScript(null,{code:"$('"+clss+"').text('');"});		
			chrome.tabs.executeScript(null,{code:"$('"+clss+"').empty();"});		
			chrome.tabs.executeScript(null,{code:"$('"+clss+"').append('"+markup+"');"});
		}
		//jayesh
		function display_next_keyword(button)
		{	
			//keyword are displayed from count to total_count-1
			alert("count=" + count);
			alert(button);
			if(button=="next")
			{
				if(flag==1)
				{
					//keyword are exhausted
					alert("no more keyword...");
				}
				else
				{
					//keywords are yet to be displayed
					if(total_count-count<6)
					{
						//less than four keyword are remaines...make flag=1
						if(total_count-count==1)	
						{
							flag=1;
							alert("no more keyword...");
						}
						else
						{
							show_keyword(count+1,total_count-1);
							count = total_count-1;
						}
					}
					else
					{
						//more than four keyword are remain
						show_keyword(count+1,count+4)
						count+=4;
					}
				}
			}
			else if(button=="prev")
			{
				//for prev button
				if(count>3)
				{
					//more than 4 keyword are available
					flag=0;
					count-=count%4+1
					show_keyword(count-3,count);
				}
				else
				{
					//total keyword are less than four
					//show_keyword(0,count);
				}			
			}
			else if(button=="tweets")
			{
				alert("showing tweets");
			}
	 	}
		function get_tweets(){
			//alert("get tweets");
			$.getJSON("http://search.twitter.com/search.json?&q=%23Apple&rpp=3",function(result)
			{
				//alert("twees response : "+result);
			});
		}
		function requesthandler(request){
			if(request.method=="showloadingimage")
			{
				//from background page	
				//alert("fromback");		
				keyword(request.url);
				alert("after keyword call is done");
			}
			else
			{
				//from contentscript
				//alert(request.button);
				display_next_keyword(request.button);
			}
			//sendResponse({"result":"pong"});
		}
		chrome.extension.onRequest.addListener(requesthandler);
</script>
</head>
</html>
